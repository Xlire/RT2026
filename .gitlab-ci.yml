# Source: https://gitlab.com/game-ci/unity3d-gitlab-ci-example

stages:
  - prepare
  - build_and_test
  # - deploy

# If you are looking for a place where to add 'UNITY_LICENSE_FILE' and other secrets, please visit your project's gitlab page:
# settings > CI/CD > Variables instead
variables:
  BUILD_NAME: simulated_forest_scanning
  IMAGE: unityci/editor # https://hub.docker.com/r/unityci/editor
  IMAGE_VERSION: 3 # This will automatically use latest v3.x.x, see https://github.com/game-ci/docker/releases
  UNITY_DIR: $CI_PROJECT_DIR # this needs to be an absolute path. Defaults to the root of your tree.
  # You can expose this in Unity via Application.version
  VERSION_NUMBER_VAR: $CI_COMMIT_REF_SLUG-$CI_PIPELINE_ID-$CI_JOB_ID
  VERSION_BUILD_VAR: $CI_PIPELINE_IID
  # Speed up cache/artifact extraction/compression
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fast"
  CACHE_COMPRESSION_LEVEL: "fast"
  # Faster than the default vfs
  DOCKER_DRIVER: overlay2

image: 
  name: $IMAGE:$UNITY_VERSION-base-$IMAGE_VERSION
  pull_policy: [if-not-present, always]

default:
  retry: 1

get-unity-version:
  image: 
    name: alpine
    pull_policy: [if-not-present, always]
  stage: prepare
  interruptible: true
  variables:
    GIT_DEPTH: 1
  script:
    - echo UNITY_VERSION=$(cat $UNITY_DIR/ProjectSettings/ProjectVersion.txt | grep "m_EditorVersion:.*" | awk '{ print $2}') | tee prepare.env
  artifacts:
    reports:
      dotenv: prepare.env

.unity_before_script: &unity_before_script
  before_script:
    - chmod +x ./ci/before_script.sh && ./ci/before_script.sh
  needs:
    - job: get-unity-version
      artifacts: true

.unity_after_script: &unity_after_script
  after_script:
    - chmod +x ./ci/return_license.sh && ./ci/return_license.sh

.cache: &cache
  cache:
    - key: $CI_COMMIT_REF_SLUG-$CI_JOB_NAME_SLUG
      fallback_keys:
        - $CI_DEFAULT_BRANCH-$CI_JOB_NAME_SLUG
      paths:
        - $UNITY_DIR/Library/
        - $UNITY_DIR/../unity-builder
    - key: apt-cache-$CI_COMMIT_REF_SLUG-$CI_JOB_NAME_SLUG
      fallback_keys:
        - apt-cache-$CI_DEFAULT_BRANCH-$CI_JOB_NAME_SLUG
      paths:
        - apt-cache/

.license: &license
  rules:
    - if: '$UNITY_LICENSE != null || $UNITY_SERIAL != null'
      when: always

.unity_defaults: &unity_defaults
  <<:
    - *unity_before_script
    - *cache
    - *license
    - *unity_after_script

.build: &build
  stage: build_and_test
  <<: *unity_defaults
  script:
    - chmod +x ./ci/build.sh && ./ci/build.sh
  # artifacts:
  #   paths:
  #     - $UNITY_DIR/Builds/
  #   expire_in: 1 day

# build-StandaloneLinux64:
#   <<: *build
#   variables:
#     BUILD_TARGET: StandaloneLinux64

# build-StandaloneLinux64-il2cpp:
#   <<: *build
#   image: $IMAGE:$UNITY_VERSION-linux-il2cpp-$IMAGE_VERSION
#   variables:
#     BUILD_TARGET: StandaloneLinux64
#     SCRIPTING_BACKEND: IL2CPP

# build-StandaloneOSX:
#   <<: *build
#   image:
#     name: $IMAGE:$UNITY_VERSION-mac-mono-$IMAGE_VERSION
#     pull_policy: [if-not-present, always]
#   variables:
#     BUILD_TARGET: StandaloneOSX

build-StandaloneWindows64:
  <<: *build
  image: 
    name: $IMAGE:$UNITY_VERSION-windows-mono-$IMAGE_VERSION
    pull_policy: [if-not-present, always]
  variables:
    BUILD_TARGET: StandaloneWindows64

.test: &test
  stage: build_and_test
  <<: *unity_defaults
  script:
    - chmod +x ./ci/test.sh && ./ci/test.sh
  artifacts:
    when: always
    expire_in: 2 weeks
  coverage: /<Linecoverage>(.*?)</Linecoverage>/

# Tests without junit reporting results in GitLab
# test-playmode:
#   <<: *test
#   variables:
#     TEST_PLATFORM: playmode
#     TESTING_TYPE: NUNIT
#
# test-editmode:
#   <<: *test
#   variables:
#     TEST_PLATFORM: editmode
#     TESTING_TYPE: NUNIT

.test-with-junit-reports: &test-with-junit-reports
  stage: build_and_test
  <<: *unity_defaults
  script:
    # This could be made faster by adding these packages to base image or running in a separate job (and step)
    # We could use an image with these two depencencies only and only do the saxonb-xslt command on
    # previous job's artifacts
    - export DEBIAN_FRONTEND=noninteractive && export APT_CACHE_DIR=`pwd`/apt-cache && mkdir -pv $APT_CACHE_DIR && apt-get update -yqq && apt-get -o dir::cache::archives="$APT_CACHE_DIR" install -yqq default-jre libsaxonb-java
    - chmod +x ./ci/test.sh && ./ci/test.sh
    - saxonb-xslt -s $UNITY_DIR/$TEST_PLATFORM-results.xml -xsl $CI_PROJECT_DIR/ci/nunit-transforms/nunit3-junit.xslt >$UNITY_DIR/$TEST_PLATFORM-junit-results.xml
  artifacts:
    when: always
    paths:
    # This is exported to allow viewing the Coverage Report in detail if needed
    - $UNITY_DIR/$TEST_PLATFORM-coverage/
    reports:
      junit:
        - $UNITY_DIR/$TEST_PLATFORM-junit-results.xml
        - "$UNITY_DIR/$TEST_PLATFORM-coverage/coverage.xml"
    expire_in: 2 weeks
  coverage: /<Linecoverage>(.*?)</Linecoverage>/

test-playmode-with-junit-reports:
  <<: *test-with-junit-reports
  variables:
    TEST_PLATFORM: playmode
    TESTING_TYPE: JUNIT

test-editmode-with-junit-reports:
  <<: *test-with-junit-reports
  variables:
    TEST_PLATFORM: editmode
    TESTING_TYPE: JUNIT

# For webgl support, you need to set Compression Format to Disabled for v0.9. See https://github.com/game-ci/docker/issues/75
# build-WebGL:
#   <<: *build
#   image: $IMAGE:$UNITY_VERSION-webgl-$IMAGE_VERSION
#   # Temporary workaround for https://github.com/game-ci/docker/releases/tag/v0.9 and webgl support in current project to prevent errors with missing ffmpeg
#   before_script:
#     - chmod +x ./ci/before_script.sh && ./ci/before_script.sh
#     - apt-get update && apt-get install ffmpeg -y
#   variables:
#     BUILD_TARGET: WebGL
#
# pages:
#   image: alpine:latest
#   stage: deploy
#   script:
#     - mv "$UNITY_DIR/Builds/WebGL/${BUILD_NAME}" public
#   artifacts:
#     paths:
#       - public
#   only:
#     - $CI_DEFAULT_BRANCH

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - when: always

generate-doxygen-pdf:
  stage: build_and_test
  image: debian:bookworm
  script:
    - apt-get update && apt-get install -y doxygen texlive-latex-recommended texlive-fonts-recommended texlive-latex-extra texlive-font-utils make
    - doxygen ci/Doxyfile
    - make -C Documentation/latex
    - mv Documentation/latex/refman.pdf Documentation/latex/simulated-forest-scanning_docs.pdf
  artifacts:
    paths:
      - Documentation/latex/simulated-forest-scanning_docs.pdf
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
